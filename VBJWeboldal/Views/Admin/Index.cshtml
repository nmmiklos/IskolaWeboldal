@model IEnumerable<VBJWeboldal.Models.News>
@using Microsoft.AspNetCore.Identity
@using VBJWeboldal.Models
@inject UserManager<ApplicationUser> UserManager
@{
    // FONTOS: Mostantól megadjuk neki az Admin layoutot!
    Layout = "_AdminLayout";
    ViewData["Title"] = "Irányítópult";
    // Lekérjük az aktuális felhasználó teljes nevét
    var currentUser = await UserManager.GetUserAsync(User);
    var fullName = currentUser?.FullName ?? User.Identity.Name;
}


<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon red">📢</div>
        <div><b>@Model.Count() bejegyzés</b></div>
    </div>
    <a href="/Admin/Documents" style="text-decoration: none; color: inherit; display: contents;">
        <div class="stat-card" style="cursor: pointer;">
            <div class="stat-icon" style="background: rgba(226, 87, 76, 0.1); color: #e2574c;">📄</div>
            <div><b>dokumentumok</b></div>
        </div>
    </a>
    @if (User.IsInRole("Admin") || User.IsInRole("GalleryManager"))
    {
        <a href="/Admin/Galleries" style="text-decoration: none; color: inherit; display: contents;">
            <div class="stat-card" style="cursor: pointer;">
                <div class="stat-icon blue">🖼️</div>
                <div><b>képek kezelése</b></div>
            </div>
        </a>
    }
    @if (User.IsInRole("Admin"))
    {
        <a href="/Admin/Users" style="text-decoration: none; color: inherit; display: contents;">
            <div class="stat-card" style="cursor: pointer;">
                <div class="stat-icon dark">👤</div>
                <div><b>felhasználók</b></div>
            </div>
        </a>
    }
</div>

<div class="content-grid">
    <div>
        <div class="card">
            <div class="card-header">Legutóbbi Bejegyzések</div>
            <table>
                <thead>
                    <tr>
                        <th>cím</th>
                        <th>szerző</th>
                        <th>dátum</th>
                        <th>státusz</th>
                        <th>műveletek</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr>
                        <tr>
                            <td>@item.Title</td>
                            <td>@(item.Author?.FullName ?? "Ismeretlen")</td>
                            <td>@item.PublishedAt.ToString("yyyy.MM.dd")</td>
                            <td>
                                @if (item.IsPublished)
                                {
                                    <span class="badge badge-success">Publikált</span>
                                }
                                else
                                {

                                    <span class="badge badge-warning">Piszkozat</span>
                                }
                            </td>
                            <td>
                                @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                                {
                                    <a href="/Admin/EditNews/@item.Id" style="color: var(--admin-primary); text-decoration: none; font-weight: bold; margin-right: 15px;">✏️ Szerkesztés</a>

                                    <form action="/Admin/DeleteNews/@item.Id" method="post" style="display: inline-block;" onsubmit="return confirm('Biztosan véglegesen törölni szeretnéd ezt a bejegyzést?');">
                                        <button type="submit" style="background: none; border: none; color: #d9534f; cursor: pointer; font-weight: bold; font-size: 14px; padding: 0;">🗑️ Törlés</button>
                                    </form>
                                }
                            </td>
                        </tr>
                        </tr>
                    }
                    @if (!Model.Any())
                    {
                        <tr><td colspan="4" style="text-align:center;">Még nincsenek bejegyzések.</td></tr>
                    }
                </tbody>
            </table>
            <div style="text-align: center; margin-top: 20px;">
                @if (User.IsInRole("Admin") || User.IsInRole("Editor"))
                {
                    <a href="/Admin/CreateNews" class="btn-primary" style="display:inline-block;">+ Új Bejegyzés</a>
                }
            </div>
        </div>
    </div>
    <div>...</div>
    <div class="card" style="margin-bottom: 24px;">
        <div class="box-h">
            <h4>Órarend frissítése (XML)</h4>
        </div>
        <div class="box-body" style="padding-top: 10px;">

            @if (TempData["SuccessMessage"] != null)
            {
                <div style="background: rgba(47, 177, 112, 0.1); border: 1px solid var(--success); color: var(--success); padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; font-weight: 600; display: inline-block;">
                    ✅ @TempData["SuccessMessage"]
                </div>
            }
            @if (TempData["ErrorMessage"] != null)
            {
                <div style="background: rgba(217, 83, 79, 0.1); border: 1px solid #d9534f; color: #d9534f; padding: 8px 12px; border-radius: 6px; margin-bottom: 15px; font-size: 13px; font-weight: 600; display: inline-block;">
                    ❌ @TempData["ErrorMessage"]
                </div>
            }

            <p style="color: var(--muted); font-size: 13px; margin-bottom: 15px;">
                Itt töltheted fel az új órarendet tartalmazó <strong>.xml vagy .xlsx</strong> kiterjesztésű fájlt. A feltöltés azonnal felülírja a jelenlegi órarendet az oldalon.
            </p>

            <form method="post" enctype="multipart/form-data" asp-action="UploadTimetable" asp-controller="Admin" style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">

                <input type="file" name="xmlFile" accept=".xml, .xlsx" required
                       style="padding: 8px; border-radius: 8px; border: 1px solid var(--line); background: var(--cardbg); color: var(--text); flex-grow: 1; max-width: 400px;" />

                <button type="submit" class="btn btn-primary">
                    Fájl feltöltése
                </button>
            </form>
        </div>
    </div>
</div>
